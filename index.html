<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Starmap Visualization</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Loader, Header, Sidebar, Maps, Tooltip, etc. remain unchanged -->

  <!-- ... [rest of the unchanged HTML] ... -->

  <!-- LOW DENSITY MAPPING Filter -->
  <fieldset>
    <legend class="collapsible" aria-expanded="false">Low Density Mapping</legend>
    <div class="filter-content">
      <div class="filter-item">
        <input type="checkbox" id="enable-low-density-mapping" name="enable-low-density-mapping" />
        <label for="enable-low-density-mapping">Enable Low Density Mapping</label>
      </div>
      <div class="filter-item">
        <label for="low-density-slider">Isolation Distance (LY):</label>
        <input type="range" id="low-density-slider" name="low-density" min="1" max="20" value="7" disabled />
        <input type="number" id="low-density-number" name="low-density" min="1" max="20" value="7" disabled />
        <span id="low-density-value">7</span> LY
      </div>
      <div class="filter-item">
        <label>Ignore this many closest stars: <span id="low-tolerance-value">0</span></label>
        <input type="range" id="low-tolerance-slider" name="low-tolerance" min="0" max="10" value="0" disabled />
      </div>
      <!-- Low Density Cluster Labeling & Segmentation toggle -->
      <div class="filter-item">
        <input type="checkbox" id="enable-low-density-labeling" name="enable-low-density-labeling" />
        <label for="enable-low-density-labeling">Enable Low Density Cluster Labeling &amp; Segmentation</label>
      </div>
      <!-- LOW DENSITY GRID SUBDIVISION: slider uses a discrete mapping -->
      <div class="filter-item">
        <label for="low-density-grid-slider">Grid Subdivision:</label>
        <!-- The slider's internal value ranges from -99 to 99 with 0 as default.
             Negative values map to fractions: value = 1/(|x|+1). Positive values map to integers: value = x+1 -->
        <input 
          type="range" 
          id="low-density-grid-slider" 
          name="low-density-grid-size" 
          min="-99" 
          max="99" 
          step="1" 
          value="0" 
          disabled
        />
        <!-- The number input shows the actual grid subdivision value -->
        <input 
          type="number" 
          id="low-density-grid-number" 
          name="low-density-grid-size" 
          min="0.01" 
          max="100" 
          step="any" 
          value="1" 
          disabled
        />
      </div>
    </div>
  </fieldset>

  <!-- HIGH DENSITY MAPPING Filter -->
  <fieldset>
    <legend class="collapsible" aria-expanded="false">High Density Mapping</legend>
    <div class="filter-content">
      <div class="filter-item">
        <input type="checkbox" id="enable-high-density-mapping" name="enable-high-density-mapping" />
        <label for="enable-high-density-mapping">Enable High Density Mapping</label>
      </div>
      <div class="filter-item">
        <label for="high-density-slider">Clustering Distance (LY):</label>
        <input type="range" id="high-density-slider" name="high-density" min="1" max="20" value="1" disabled />
        <input type="number" id="high-density-number" name="high-density" min="1" max="20" value="1" disabled />
        <span id="high-density-value">1</span> LY
      </div>
      <div class="filter-item">
        <label>Ignore this many closest stars: <span id="high-tolerance-value">0</span></label>
        <input type="range" id="high-tolerance-slider" name="high-tolerance" min="0" max="10" value="0" disabled />
      </div>
      <!-- High Density Cluster Labeling & Segmentation toggle -->
      <div class="filter-item">
        <input type="checkbox" id="enable-high-density-labeling" name="enable-high-density-labeling" />
        <label for="enable-high-density-labeling">Enable High Density Cluster Labeling &amp; Segmentation</label>
      </div>
      <!-- HIGH DENSITY GRID SUBDIVISION: slider uses the same discrete mapping -->
      <div class="filter-item">
        <label for="high-density-grid-slider">Grid Subdivision:</label>
        <input 
          type="range" 
          id="high-density-grid-slider" 
          name="high-density-grid-size" 
          min="-99" 
          max="99" 
          step="1" 
          value="0" 
          disabled
        />
        <input 
          type="number" 
          id="high-density-grid-number" 
          name="high-density-grid-size" 
          min="0.01" 
          max="100" 
          step="any" 
          value="1" 
          disabled
        />
      </div>
    </div>
  </fieldset>

  <!-- ... [rest of the unchanged HTML: closing tags, scripts, etc.] ... -->

  <!-- Scripts -->
  <script type="module" src="script.js"></script>
  <script>
    // Define mapping functions for the grid subdivision slider:
    function sliderToGridValue(sliderVal) {
      const intVal = parseInt(sliderVal, 10);
      if (intVal === 0) return 1;
      if (intVal < 0) return 1 / (Math.abs(intVal) + 1);
      return intVal + 1;
    }
    function gridValueToSlider(gridVal) {
      gridVal = parseFloat(gridVal);
      if (gridVal === 1) return 0;
      if (gridVal < 1) return - (Math.round(1 / gridVal) - 1);
      return Math.round(gridVal) - 1;
    }

    // Wrap event listener setup to ensure DOM elements exist
    document.addEventListener('DOMContentLoaded', function() {

      // (Other event listeners remain unchanged...)

      // Sync low density grid slider and number input using discrete mapping
      document.getElementById('low-density-grid-slider').addEventListener('input', function() {
          const gridValue = sliderToGridValue(this.value);
          // Use a fixed number of decimal places for display (up to 3 decimals)
          document.getElementById('low-density-grid-number').value = gridValue.toFixed(3);
      });
      document.getElementById('low-density-grid-number').addEventListener('input', function() {
          const sliderVal = gridValueToSlider(this.value);
          document.getElementById('low-density-grid-slider').value = sliderVal;
      });

      // Sync high density grid slider and number input using discrete mapping
      document.getElementById('high-density-grid-slider').addEventListener('input', function() {
          const gridValue = sliderToGridValue(this.value);
          document.getElementById('high-density-grid-number').value = gridValue.toFixed(3);
      });
      document.getElementById('high-density-grid-number').addEventListener('input', function() {
          const sliderVal = gridValueToSlider(this.value);
          document.getElementById('high-density-grid-slider').value = sliderVal;
      });

      // (All other event listeners for checkboxes, sliders, number inputs, and fullscreen remain unchanged)
    });
  </script>
</body>
</html>
